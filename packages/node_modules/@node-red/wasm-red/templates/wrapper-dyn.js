// Use rollup to inject here all the dependencies

// Load Node utils here
// const utils = require("../../");

// this.process = require("wasm-red-process");
// commonjsGlobal.process = process;

{{#dependencies}}
{{{.}}};
{{/dependencies}}

// This is a patch for rollup
let module = {
  "type": "wasm-wrapping"
};

// Some useful logging
//console.log("Initializing context. Reading msg and node from Node.IO");
let msg = Node.IO.msg();
let node =  Node.IO.node();

const send = Node.IO.send;
const done = Node.IO.done;
// A lot of aliases
const nodeSend = send;
const nodeDone = done;

node.nodeSend = nodeSend;
node.nodeDone = nodeDone;
node.send = send;
node.done = done;

// The dirname is the relative root folder.
// TODO make the call to Node-RED to get it.
const __dirname = ".";

// This disables i18n. In practice we do not need this for the MVP
RED._ = function(obj) {
  return obj;
}

{{{
  inner_code
}}}



function main() {
  // Some useful logging
  //console.log("Executing inside Javy's WASM VM");

  // let now = Date.now();
  let r = {{mm}}({{{args}}});
  // let elapsed = Date.now() - now;
  // console.log("Elapsed time (inside wasm)", elapsed);
  //console.log("Executing inside Javy's WASM VM finishes");
  return r;
}

main();